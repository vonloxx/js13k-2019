var r=function(){var r,t,n,a,e,i=function(r){return Math.sin(6.283184*r)},o=function(r){return.003959503758*Math.pow(2,(r-128)/12)},f=function(r,t,n){var a,e,i,f,c,h,s,p=u[r.i[0]],v=r.i[1],d=r.i[3],w=u[r.i[4]],l=r.i[5],y=r.i[8],M=r.i[9],g=r.i[10]*r.i[10]*4,m=r.i[11]*r.i[11]*4,A=r.i[12]*r.i[12]*4,C=1/A,D=r.i[13],L=n*Math.pow(2,2-r.i[14]),U=new Int32Array(g+m+A),x=0,I=0;for(a=0,e=0;a<g+m+A;a++,e++)e>=0&&(e-=L,h=o(t+(15&(D=D>>8|(255&D)<<4))+r.i[2]-128),s=o(t+(15&D)+r.i[6]-128)*(1+8e-4*r.i[7])),i=1,a<g?i=a/g:a>=g+m&&(i-=(a-g-m)*C),f=h,d&&(f*=i*i),c=p(x+=f)*v,f=s,y&&(f*=i*i),c+=w(I+=f)*l,M&&(c+=(2*Math.random()-1)*M),U[a]=80*c*i|0;return U},u=[i,function(r){return r%1<.5?1:-1},function(r){return r%1*2-1},function(r){var t=r%1*4;return t<2?t-1:3-t}];this.init=function(i){r=i,n=0,a=i.rowLen*i.patternLen*((t=i.endPattern)+1)*2,e=new Int32Array(a)},this.generate=function(){var o,c,h,s,p,v,d,w,l,y,M,g,m,A,C=new Int32Array(a),D=r.songData[n],L=r.rowLen,U=r.patternLen,x=0,I=0,W=!1,_=[];for(h=0;h<=t;++h)for(d=D.p[h],s=0;s<U;++s){var b=d?D.c[d-1].f[s]:0;b&&(D.i[b-1]=D.c[d-1].f[s+U]||0,b<16&&(_=[]));var j=u[D.i[15]],q=D.i[16]/512,E=Math.pow(2,D.i[17]-9)/L,O=D.i[18],P=D.i[19],k=43.23529*D.i[20]*3.141592/44100,z=1-D.i[21]/255,B=1e-5*D.i[22],F=D.i[23]/32,G=D.i[24]/512,H=6.283184*Math.pow(2,D.i[25]-9)/L,J=D.i[26]/255,K=D.i[27]*L&-2;for(M=(h*U+s)*L,p=0;p<4;++p)if(v=d?D.c[d-1].n[s+p*U]:0){_[v]||(_[v]=f(D,v,L));var N=_[v];for(c=0,o=2*M;c<N.length;c++,o+=2)C[o]+=N[c]}for(c=0;c<L;c++)(y=C[w=2*(M+c)])||W?(g=k,O&&(g*=j(E*w)*q+.5),I+=(g=1.5*Math.sin(g))*(m=z*(y-I)-(x+=g*I)),y=3==P?I:1==P?m:x,B&&(y=(y*=B)<1?y>-1?i(.25*y):-1:1,y/=B),W=(y*=F)*y>1e-5,A=y*(1-(l=Math.sin(H*w)*G+.5)),y*=l):A=0,w>=K&&(A+=C[w-K+1]*J,y+=C[w-K]*J),C[w]=0|A,C[w+1]=0|y,e[w]+=0|A,e[w+1]+=0|y}return++n/r.numChannels},this.createWave=function(){var r=44+2*a-8,t=r-36,n=new Uint8Array(44+2*a);n.set([82,73,70,70,255&r,r>>8&255,r>>16&255,r>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&t,t>>8&255,t>>16&255,t>>24&255]);for(var i=0,o=44;i<a;++i){var f=e[i];n[o++]=255&(f=f<-32767?-32767:f>32767?32767:f),n[o++]=f>>8&255}return n},this.getData=function(r,t){for(var n=2*Math.floor(44100*r),a=[],i=0;i<2*t;i+=1){var o=n+i;a[i]=r>0&&o<e.length?e[o]/32768:0}return a}},t={palette:[[124,124,124],[0,0,252],[0,0,188],[68,40,188],[148,0,132],[168,0,32],[168,16,0],[136,20,0],[80,48,0],[0,120,0],[0,104,0],[0,88,0],[0,64,88],[0,0,0],[188,188,188],[0,120,248],[0,88,248],[104,68,252],[216,0,204],[228,0,88],[248,56,0],[228,92,16],[172,124,0],[0,184,0],[0,168,0],[0,168,68],[0,136,136],[248,248,248],[60,188,252],[104,136,252],[152,120,248],[248,120,248],[248,88,152],[248,120,88],[252,160,68],[248,184,0],[88,216,84],[88,248,152],[0,232,216],[120,120,120],[252,252,252],[164,228,252],[184,184,248],[216,184,248],[248,184,248],[248,164,192],[240,208,176],[252,224,168],[248,216,120],[216,248,120],[184,248,184],[184,248,216],[0,252,252],[216,216,216]],step:1,errorDiffusionDither:function(r,t,n){for(var a=new Uint8ClampedArray(r.data),e=new Uint8ClampedArray(r.data),i=this.step,o=0;o<n;o+=i)for(var f=0;f<t;f+=i){var u=4*f+4*o*t,c=function(r,n){return 4*r+4*n*t},h=u,s=u+1,p=u+2,v=new Array(a[h],a[s],a[p]),d=this.approximateColor(v),w=[];w[h]=a[h]-d[0],w[s]=a[s]-d[1],w[p]=a[p]-d[2],a[c(f+i,o)]=a[c(f+i,o)]+.4375*w[h],a[c(f-i,o+1)]=a[c(f-1,o+i)]+.1875*w[h],a[c(f,o+i)]=a[c(f,o+i)]+.3125*w[h],a[c(f+i,o+i)]=a[c(f+1,o+i)]+.0625*w[h],a[c(f+i,o)+1]=a[c(f+i,o)+1]+.4375*w[s],a[c(f-i,o+i)+1]=a[c(f-i,o+i)+1]+.1875*w[s],a[c(f,o+i)+1]=a[c(f,o+i)+1]+.3125*w[s],a[c(f+i,o+i)+1]=a[c(f+i,o+i)+1]+.0625*w[s],a[c(f+i,o)+2]=a[c(f+i,o)+2]+.4375*w[p],a[c(f-i,o+i)+2]=a[c(f-i,o+i)+2]+.1875*w[p],a[c(f,o+i)+2]=a[c(f,o+i)+2]+.3125*w[p],a[c(f+i,o+i)+2]=a[c(f+i,o+i)+2]+.0625*w[p];for(var l=d[0],y=d[1],M=d[2],g=0;g<i;g++)for(var m=0;m<i;m++){var A=u+4*g+4*t*m;e[A]=l,e[A+1]=y,e[A+2]=M}}return e},dither:function(r,t,n){for(var a=new Uint8ClampedArray(r.data),e=new Array([1,9,3,11],[13,5,15,7],[4,12,2,10],[16,8,14,6]),i=0;i<n;i+=1)for(var o=0;o<t;o+=1){var f=4*o+4*i*t,u=f,c=f+1,h=f+2;a[u]+=2*e[o%4][i%4],a[c]+=2*e[o%4][i%4],a[h]+=2*e[o%4][i%4];for(var s=new Array(a[u],a[c],a[h]),p=this.approximateColor(s),v=p[0],d=p[1],w=p[2],l=0;l<1;l++)for(var y=0;y<1;y++){var M=f+4*l+4*t*y;a[M]=v,a[M+1]=d,a[M+2]=w}}return a},approximateColor:function(r){var t=this.palette,n=function(r,t,a,e){if(2==a.length)return r(t,e)<=r(t,a[1])?e:a[1];var i=a.slice(1);return e=r(t,e)<=r(t,a[1])?e:a[1],n(r,t,i,e)};return n(this.colorDistance,r,t,t[0])},colorDistance:function(r,t){return Math.sqrt(Math.pow(r[0]-t[0],2)+Math.pow(r[1]-t[1],2)+Math.pow(r[2]-t[2],2))}};function n(t){const n=new r;for(n.init(t);n.generate()<1;);return n.createWave()}function a(r){const{width:n,height:a,image_data:e}=r;return t.dither(e,n,a)}onmessage=function(r){const t={};Object.entries(r.data).forEach(r=>{t[r[0]]="song"===r[1].type?{type:r[1].type,data:n(r[1].data)}:"dithered"===r[1].type?{type:r[1].type,data:{...r[1].data,image_data:a(r[1].data)}}:r[1]}),postMessage(t)};
